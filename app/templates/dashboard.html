









{% extends "base.html" %}

{% block title %}Dashboard - ChronoStories{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-chart-bar"></i> AI Dashboard</h1>
            <p class="text-muted">Monitor your AI-powered story generation platform</p>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card metric-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Total Stories</h6>
                            <h3 class="mb-0">{{ metrics.total_stories }}</h3>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Total Views</h6>
                            <h3 class="mb-0">{{ metrics.total_views|number_format }}</h3>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Avg Views/Story</h6>
                            <h3 class="mb-0">{{ metrics.avg_views_per_story|round(1) }}</h3>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card metric-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Active Trends</h6>
                            <h3 class="mb-0">{{ active_trends }}</h3>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-fire fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> AI Control Panel</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <button class="btn btn-primary w-100" onclick="generateNewsStory()">
                                <i class="fas fa-newspaper"></i> Generate News Story
                            </button>
                        </div>
                        <div class="col-6 mb-3">
                            <button class="btn btn-success w-100" onclick="generateTrendStory()">
                                <i class="fas fa-fire"></i> Generate Trend Story
                            </button>
                        </div>
                        <div class="col-6 mb-3">
                            <button class="btn btn-info w-100" onclick="startAutoMode()">
                                <i class="fas fa-play"></i> Start Auto Mode
                            </button>
                        </div>
                        <div class="col-6 mb-3">
                            <button class="btn btn-danger w-100" onclick="stopAutoMode()">
                                <i class="fas fa-stop"></i> Stop Auto Mode
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label for="topicInput" class="form-label">Custom Topic (Optional):</label>
                        <input type="text" class="form-control" id="topicInput" placeholder="Enter specific topic...">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> System Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-success">AI Brain: Online</span>
                        <span class="badge bg-primary">News Monitor: Active</span>
                        <span class="badge bg-info">Trend Scanner: Running</span>
                    </div>
                    
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 85%">
                            System Health: 85%
                        </div>
                    </div>
                    
                    <div class="status-messages" id="statusMessages">
                        <small class="text-muted">System ready. Ready to generate stories.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% if recent_stories %}
                            {% for story in recent_stories %}
                                <div class="activity-item">
                                    <div class="activity-icon bg-primary">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6>{{ story.title }}</h6>
                                        <p class="mb-1">
                                            <small class="text-muted">
                                                <i class="fas fa-tag"></i> {{ story.category|title }} | 
                                                <i class="fas fa-clock"></i> {{ story.created_at.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </p>
                                        <p class="mb-0">{{ story.summary[:100] }}{% if story.summary|length > 100 %}...{% endif %}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No recent activity. Generate your first story!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Category Performance</h5>
                </div>
                <div class="card-body">
                    {% if category_performance %}
                        <div class="category-stats">
                            {% for category, stats in category_performance.items() %}
                                <div class="category-item mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="category-name">{{ category|title }}</span>
                                        <span class="badge bg-primary">{{ stats.count }} stories</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-info" 
                                             role="progressbar" 
                                             style="width: {{ (stats.avg_views / max_views * 100)|default(50)|int }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Avg: {{ stats.avg_views|round(0) }} views
                                    </small>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>No performance data available.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- API Logs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-code"></i> Recent API Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="apiLogs">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Loading API logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
let autoModeInterval = null;
let apiLogsInterval = null;

function updateStatus(message, type = 'info') {
    const statusMessages = document.getElementById('statusMessages');
    const timestamp = new Date().toLocaleTimeString();
    const alertClass = type === 'success' ? 'text-success' : 
                      type === 'error' ? 'text-danger' : 'text-info';
    
    statusMessages.innerHTML = `<small class="${alertClass}">[${timestamp}] ${message}</small>`;
}

function generateNewsStory() {
    const topic = document.getElementById('topicInput').value;
    updateStatus('Generating news story...', 'info');
    
    fetch('/api/generate-story', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            source: 'news',
            topic: topic
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(`News story generated successfully! ID: ${data.story_id}`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            updateStatus(`Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        updateStatus(`Network error: ${error.message}`, 'error');
    });
}

function generateTrendStory() {
    const topic = document.getElementById('topicInput').value;
    updateStatus('Generating trend story...', 'info');
    
    fetch('/api/generate-trend-story', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            topic: topic
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus(`Trend story generated successfully! ID: ${data.story_id}`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            updateStatus(`Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        updateStatus(`Network error: ${error.message}`, 'error');
    });
}

function startAutoMode() {
    if (autoModeInterval) {
        updateStatus('Auto mode is already running!', 'warning');
        return;
    }
    
    updateStatus('Starting auto mode...', 'info');
    
    fetch('/api/start-auto-mode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus('Auto mode started successfully!', 'success');
            autoModeInterval = setInterval(() => {
                updateStatus('Auto mode: Generating stories automatically...', 'info');
            }, 30000);
        } else {
            updateStatus(`Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        updateStatus(`Network error: ${error.message}`, 'error');
    });
}

function stopAutoMode() {
    if (!autoModeInterval) {
        updateStatus('Auto mode is not running!', 'warning');
        return;
    }
    
    updateStatus('Stopping auto mode...', 'info');
    
    fetch('/api/stop-auto-mode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus('Auto mode stopped successfully!', 'success');
            clearInterval(autoModeInterval);
            autoModeInterval = null;
        } else {
            updateStatus(`Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        updateStatus(`Network error: ${error.message}`, 'error');
    });
}

function loadApiLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(data => {
            const logsBody = document.getElementById('apiLogs');
            
            if (data.logs && data.logs.length > 0) {
                logsBody.innerHTML = data.logs.map(log => `
                    <tr>
                        <td><small>${new Date(log.created_at).toLocaleTimeString()}</small></td>
                        <td><small>${log.action}</small></td>
                        <td>
                            <span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">
                                ${log.status}
                            </span>
                        </td>
                        <td><small>${log.details || 'N/A'}</small></td>
                    </tr>
                `).join('');
            } else {
                logsBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> No recent API activity
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading API logs:', error);
        });
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadApiLogs();
    apiLogsInterval = setInterval(loadApiLogs, 30000); // Refresh every 30 seconds
    
    // Add some initial status
    updateStatus('Dashboard loaded successfully!', 'success');
});

// Clean up intervals on page unload
window.addEventListener('beforeunload', function() {
    if (autoModeInterval) clearInterval(autoModeInterval);
    if (apiLogsInterval) clearInterval(apiLogsInterval);
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    max-width: 1400px;
}

.metric-card {
    border: none;
    border-radius: 15px;
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-3px);
}

.metric-icon {
    opacity: 0.7;
}

.activity-timeline {
    position: relative;
}

.activity-item {
    display: flex;
    margin-bottom: 20px;
    position: relative;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 15px;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
}

.activity-content h6 {
    margin-bottom: 5px;
}

.category-stats .category-item {
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.category-stats .category-item:last-child {
    border-bottom: none;
}

.category-name {
    font-weight: 500;
}

.status-messages {
    min-height: 20px;
}

@media (max-width: 768px) {
    .metric-card {
        margin-bottom: 1rem;
    }
    
    .activity-item {
        flex-direction: column;
    }
    
    .activity-icon {
        margin-bottom: 10px;
        margin-right: 0;
    }
}
</style>
{% endblock %}











